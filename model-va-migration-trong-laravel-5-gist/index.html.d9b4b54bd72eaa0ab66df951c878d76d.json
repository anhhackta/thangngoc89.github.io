{"head":{"layout":"Post","title":"Migration và Model trong Laravel 5 - Larask Gist","date":"2015-03-12T19:00:00.000Z","description":"Hướng dẫn tạo và sử dụng migration trong Laravel 5 - Series Larask Gist","tags":["laravel"]},"body":"<p>Đây là bài viết thứ hai trong series <a href=\"/gioi-thieu-series-larask-gist/\">Larask Gist</a> .</p>\n<p>Các bạn có thể xem code của toàn bộ bài viết tại <a href=\"https://github.com/Larask/gist/tree/d3e5e96139fce98e028834035bb41759fd49b62e\">github</a></p>\n<h1 id=\"model\"><a href=\"#model\" class=\"phenomic-HeadingAnchor\">#</a>Model</h1>\n<p>Trong <a href=\"/tim-hieu-mo-hinh-mvc-la-gi/\">mô hình MVC</a> thì Model đóng vai trò giao tiếp với database. Laravel đi kèm với Eloquent, một <a href=\"http://yhoc.co/orm-eloquent\">ORM</a>  với Active Record Pattern. <a href=\"http://yhoc.co/active-record-data-mapper\">(xem chi tiết về các pattern ORM)</a> . Trong Active Record Pattern thì mỗi object sẽ đại diện cho một dòng trong table. Điều này làm cho việc tương tác với database dễ hơn bao giờ hết.</p>\n<p>Laravel 5 đi kèm với model User mặc định <code>app/User.php</code> và class này sẽ đại diện cho User trong toàn bộ ứng dụng của bạn.</p>\n<h1 id=\"migration\"><a href=\"#migration\" class=\"phenomic-HeadingAnchor\">#</a>Migration</h1>\n<p>Bạn quản lí code bằng git như database, một thành phần quan trọng không kém là database thì không được như vậy. Vì vậy migration được tạo ra để quản lí sự thay đổi cấu trúc dữ liệu. Việc sử dụng migration sẽ giúp bạn giảm nhẹ công việc khi deploy ứng dụng.</p>\n<p>Lấy ví dụ như một ngày đẹp trời, bạn muốn thêm vào database table <code>dogs</code>. Ở localhost, bạn vào phpmyadmin (hay bất cứ công cụ quản lí nào bạn sử dụng, kể cả cli) chạy query tạo ra table <code>dogs</code>. Sau khi thêm vào code để sử dụng table mới này.\nBạn muốn up code lên host/vps. Okie. Push code lên github, pull code trên vps(hoặc dùng webhooks để tự động hóa luôn). Còn database thì sao? Ừm lên phpmyadmin của vps chạy query tiếp. Nhưng ... query chính xác là gì :disappointed: ?</p>\n<p>Nếu bạn sử dụng migration ngay từ đầu thì việc duy nhất bạn cần làm trên cả local và host/vps là chạy lên <code>php artisan migrate</code> để thực hiện việc cập nhật database.</p>\n<h1 id=\"tạo-migration-và-model\"><a href=\"#t%E1%BA%A1o-migration-v%C3%A0-model\" class=\"phenomic-HeadingAnchor\">#</a>Tạo migration và model</h1>\n<p>Bây giờ chúng ta suy nghĩ về cấu trúc của ứng dụng. Ứng dụng của chúng ta tập trung về Gist nên chúng ta sẽ đặt tên table sẽ là <code>gists</code> và model sẽ là <code>Gist</code>. Như vậy chúng ta cần làm 2 việc :</p>\n<ul>\n<li>Tạo model <code>Gist</code></li>\n<li>Dùng migration để tạo ra table <code>gists</code></li>\n</ul>\n<p>Laravel 5 cung cấp cho chúng ta công cụ tiện dụng để làm việc này. Mở Cmder :</p>\n<pre><code class=\"hljs language-shell\">php artisan make:<span class=\"hljs-keyword\">model</span> Gist\n\n<span class=\"hljs-keyword\">Model</span> created successfully.\nCreated Migration: yyyy_mm_dd_xxxxxx_create_gists_table</code></pre>\n<p>Các bạn sẽ thấy xuất hiện 2 file mới là <code>app/Gist.php</code> và <code>database/migrations/yyyy_mm_dd_xxxxxx_create_gists_table.php</code> với <code>yyyy_mm_dd_xxxxxx</code> là thời điểm migration này được tạo ra.</p>\n<h1 id=\"thiết-lập-cấu-trúc-dữ-liệu\"><a href=\"#thi%E1%BA%BFt-l%E1%BA%ADp-c%E1%BA%A5u-tr%C3%BAc-d%E1%BB%AF-li%E1%BB%87u\" class=\"phenomic-HeadingAnchor\">#</a>Thiết lập cấu trúc dữ liệu</h1>\n<h2 id=\"users-table\"><a href=\"#users-table\" class=\"phenomic-HeadingAnchor\">#</a>Users table</h2>\n<ul>\n<li>Trước hết chúng ta hãy xem qua cấu trúc của file <code>database/migrations/2014_10_12_100000_create_user_table.php</code></li>\n</ul>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-comment\">/**\n  * Run the migrations.\n  *\n  * <span class=\"hljs-doctag\">@return</span> void\n  */</span>\n  <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">up</span> <span class=\"hljs-params\">()</span> </span>{\n    Schema::create(<span class=\"hljs-string\">'users'</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span><span class=\"hljs-params\">(Blueprint $table)</span> </span>{\n      $table->increments(<span class=\"hljs-string\">'id'</span>);\n      $table->string(<span class=\"hljs-string\">'name'</span>);\n      $table->string(<span class=\"hljs-string\">'email'</span>)->unique();\n      $table->string(<span class=\"hljs-string\">'password'</span>, <span class=\"hljs-number\">60</span>);\n      $table->rememberToken();\n      $table->timestamps();\n    });\n  }\n\n<span class=\"hljs-comment\">/**\n  * Reverse the migrations.\n  *\n  * <span class=\"hljs-doctag\">@return</span> void\n  */</span>\n\n  <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">down</span><span class=\"hljs-params\">()</span> </span>{\n    Schema::drop(<span class=\"hljs-string\">'users'</span>);\n  }</code></pre>\n<p>Class này có 2 function là <code>up()</code> và <code>down()</code>.</p>\n<p>Function <code>up()</code> sẽ được gọi khi bạn chạy lệnh <code>php artisan migrate</code>\ncòn function <code>down()</code> sẽ được gọi khi bạn chạy lệnh <code>php artisan migrate:rollback</code> .</p>\n<p>Các tên hàm theo mình thấy là rất dễ hiểu rồi. Nhìn vào các bạn có thể tưởng tượng được cấu trúc table <code>users</code> như thế nào.</p>\n<p>Mình sẽ sửa table <code>users</code> này như sau :</p>\n<ul>\n<li>Thêm một cột <code>username</code> kiểu <code>var_char(20)</code> với <code>unique key</code>.</li>\n<li>Cho phép email có thể <code>NULL</code>  (believe me about this)</li>\n<li>Index và unsigned cột <code>id</code></li>\n</ul>\n<p>Và mình có function <code>up()</code> hoàn chỉnh:</p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-comment\">/**\n  * Run the migrations.\n  *\n  * <span class=\"hljs-doctag\">@return</span> void\n  */</span>\n  <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">up</span><span class=\"hljs-params\">()</span> </span>{\n    Schema::create(<span class=\"hljs-string\">'users'</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span><span class=\"hljs-params\">(Blueprint $table)</span> </span>{\n      $table->increments(<span class=\"hljs-string\">'id'</span>)->index();\n      $table->string(<span class=\"hljs-string\">'name'</span>);\n      $table->string(<span class=\"hljs-string\">'username'</span>, <span class=\"hljs-number\">20</span>)->nullable()->default(<span class=\"hljs-keyword\">null</span>)->unique();\n      $table->string(<span class=\"hljs-string\">'email'</span>)->nullable()->default(<span class=\"hljs-keyword\">null</span>)->unique();\n      $table->string(<span class=\"hljs-string\">'password'</span>, <span class=\"hljs-number\">60</span>);\n      $table->rememberToken();\n      $table->timestamps();\n    });\n  }</code></pre>\n<p>Nguyên nhân mình cho 2 cột <code>email</code> và <code>username</code> nullable là sau này,\nnếu bạn muốn tích hợp chức năng login với Facebook/Google+/Twitter ...\nthì nhiều khi các dịch vụ này sẽ không cung cấp email hay username (nhất là Facebook).\nVì vậy, cứ để cho nó null sau này sẽ tính sau.</p>\n<p>Các bạn có thể xem các lệnh khác nhau của\n<a href=\"http://laravel.com/docs/5.0/schema\">class Schema tại đây</a></p>\n<h2 id=\"gists-table\"><a href=\"#gists-table\" class=\"phenomic-HeadingAnchor\">#</a>Gists table</h2>\n<p>Chúng ta sẽ đi nhanh qua phần này, ở đây mình có sẵn file migration cho gists table</p>\n<pre><code class=\"hljs language-php\"><span class=\"hljs-meta\">&#x3C;?php</span>\n\n<span class=\"hljs-keyword\">use</span> <span class=\"hljs-title\">Illuminate</span>\\<span class=\"hljs-title\">Database</span>\\<span class=\"hljs-title\">Schema</span>\\<span class=\"hljs-title\">Blueprint</span>;\n<span class=\"hljs-keyword\">use</span> <span class=\"hljs-title\">Illuminate</span>\\<span class=\"hljs-title\">Database</span>\\<span class=\"hljs-title\">Migrations</span>\\<span class=\"hljs-title\">Migration</span>;\n\n<span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">CreateGistsTable</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">Migration</span> </span>{\n  <span class=\"hljs-comment\">/**\n   * Run the migrations.\n   *\n   * <span class=\"hljs-doctag\">@return</span> void\n   */</span>\n  <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">up</span><span class=\"hljs-params\">()</span> </span>{\n    Schema::create(<span class=\"hljs-string\">'gists'</span>, <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span><span class=\"hljs-params\">(Blueprint $table)</span> </span>{\n      $table->increments(<span class=\"hljs-string\">'id'</span>)->index();\n      $table->unsignedInteger(<span class=\"hljs-string\">'user_id'</span>)->nullable()->index();\n      $table->string(<span class=\"hljs-string\">'title'</span>);\n      $table->longText(<span class=\"hljs-string\">'content'</span>);\n      $table->boolean(<span class=\"hljs-string\">'public'</span>);\n      $table->timestamps();\n      $table->softDeletes();\n      $table->foreign(<span class=\"hljs-string\">'user_id'</span>)->references(<span class=\"hljs-string\">'id'</span>)->on(<span class=\"hljs-string\">'users'</span>)->onDelete(<span class=\"hljs-string\">'SET NULL'</span>);\n    });\n  }\n\n  <span class=\"hljs-comment\">/**\n   * Reverse the migrations.\n   *\n   * <span class=\"hljs-doctag\">@return</span> void\n   */</span>\n  <span class=\"hljs-keyword\">public</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">down</span><span class=\"hljs-params\">()</span> </span>{\n    Schema::drop(<span class=\"hljs-string\">'gists'</span>);\n  }\n}</code></pre>\n<p>Ở đây chúng ta có cột <code>public</code> với kiểu boolean để chứa trạng thái public/private của gists.</p>\n<p><code>$table->softDeletes();</code> dùng để tạo một cột <code>deleted_at</code> (chúng ta sẽ nói về vấn đề này sau).</p>\n<p>Cuối cùng là <code>$table->foreign('user_id')->references('id')->on('users')->onDelete('SET NULL');</code> để set foreign constraint giữa <code>gists</code> table và <code>users</code> table. Ở đây mình muốn khi user bị xóa ra khỏi database thì gists của họ vẫn còn tồn tại trong hệ thống.</p>\n<p>Okie. So far so good. Mở Cmder lên và gõ lệnh</p>\n<pre><code class=\"hljs language-shell\"><span class=\"hljs-attribute\">php artisan migrate</span></code></pre>\n<p>Vào kiểm tra trong phpmyadmin, mọi cấu trúc đã có ở trong table. Laravel sẽ tự động tạo thêm table <code>migrations</code> để quản lí migrations cho bạn. Bạn không cần quan tâm về table này</p>\n<p>Gõ lệnh</p>\n<pre><code class=\"hljs language-shell\"><span class=\"hljs-selector-tag\">php</span> <span class=\"hljs-selector-tag\">artisan</span> <span class=\"hljs-selector-tag\">migrate</span><span class=\"hljs-selector-pseudo\">:rollback</span></code></pre>\n<p>Kiểm tra lại trong database. Toàn bộ cấu trúc đã biến mất (trừ table <code>migrations</code> ). Yay me.</p>\n<h1 id=\"kết-luận\"><a href=\"#k%E1%BA%BFt-lu%E1%BA%ADn\" class=\"phenomic-HeadingAnchor\">#</a>Kết luận</h1>\n<p>Bằng việc sử dụng, kết hợp model và migration trong Laravel, việc lập trình của bạn sẽ dễ dàng hơn bao giờ hết. Nếu bạn làm việc theo team. Mọi thay đổi về cấu trúc database của được cập nhật đến mọi thành viên của nhóm một cách nhanh chóng.</p>\n","__filename":"model-va-migration-trong-laravel-5-gist.md","__url":"/model-va-migration-trong-laravel-5-gist/","__resourceUrl":"/model-va-migration-trong-laravel-5-gist/index.html","__dataUrl":"/model-va-migration-trong-laravel-5-gist/index.html.d9b4b54bd72eaa0ab66df951c878d76d.json"}