{"head":{"layout":"Post","title":"json ⊄ js","date":"2016-02-19T23:22:00.000Z","tags":["js","json"],"translate":{"url":"https://medium.com/joys-of-javascript/json-js-42a28471221d#.m23ozaapw","author":"Dan Pupius"},"description":"Mọi người thường nói rằng JSON là một phần nhỏ (subset) của Javascript. Vấn đề là nó không phải như vậy. Dựa vào spec của JSON, một chuỗi có thể chứa bất cứ kí tự unicode nào ngoại trừ \" hoặc / hoặc…"},"body":"<p>Mọi người thường nói rằng JSON là một phần nhỏ (subset) của Javascript.</p>\n<p>Vấn đề là nó không phải như vậy.</p>\n<p>Dựa vào <a href=\"http://www.json.org/\">spec</a> của JSON, một chuỗi có thể chứa bất cứ kí tự unicode nào ngoại trừ <code>&quot;</code> hoặc <code>/</code> hoặc kí tự điều khiển.</p>\n<p>Điều là có nghĩa là chuỗi dưới đây hoàn toàn hợp lệ với JSON:</p>\n<script src=\"https://gist.github.com/thangngoc89/b136d0aabdbff3d8afa4.js\"></script>\n<p>Hãy thử copy chuỗi trên và dán vào console, gán cho nó 1 biến bất kì. Thử đi, mình sẽ chờ.</p>\n<p>Yup. <code>“SyntaxError: Unexpected token ILLEGAL”.</code></p>\n<p>Vấn đề nằm ở 2 kí tự unicode được được Javascript định nghĩa là kí tự kết thúc dòng: kí tự kết thúc dòng <code>\\u2028</code> và kí tự phân cách đoạn văn <code>u2029</code>. Chuỗi trên nếu được escape thì sẽ như thế này <code>own\\u2028ed</code>.</p>\n<h1 id=\"Van-de-nam-o-dau\"><a class=\"markdownIt-Anchor\" href=\"#Van-de-nam-o-dau\">#</a> Vấn đề nằm ở đâu ?</h1>\n<p>JSON hiện tại được dùng như là một cách thuận tiện định dạng dữ liệu và hầu hết trường hợp không dùng JSON dựa trên <strong>JSON là một phần nhỏ của JS</strong>. Tuy nhiên, có vài trường hợp nó sẽ gây ra vấn đề.</p>\n<p>Trong <a href=\"http://en.wikipedia.org/wiki/JSONP\">JSONP</a> (JSON with padding), server gửi dữ liệu kèm với một callback sẽ được chạy ở trang yêu cầu dữ liệu:</p>\n<pre><code class=\"language-js\">handleResponse({<span class=\"hljs-string\">\"status\"</span>: <span class=\"hljs-string\">\"ok\"</span>, <span class=\"hljs-string\">\"id\"</span>: <span class=\"hljs-number\">123456</span>});</code></pre>\n<p>Vài thư viện javascript sử dụng một phương thức không an toàn, nhưng nhanh, parse JSON sử dụng <code>eval</code> để hỗ trợ các trình duyệt cũ:</p>\n<pre><code class=\"language-js\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">unsafeParse</span>(<span class=\"hljs-params\">json</span>) </span>{\n <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">eval</span>(<span class=\"hljs-string\">\"(\"</span> + json + <span class=\"hljs-string\">\")\"</span>);\n}</code></pre>\n<p>Và trường hợp thông dụng nhất là chèn các dữ liệu từ được tạo ra từ server để tránh phải gửi thêm request mới.</p>\n<pre><code class=\"language-js\"><span class=\"hljs-keyword\">var</span> GLOBALS = {\n <span class=\"hljs-string\">\"userid\"</span>: <span class=\"hljs-number\">123456</span>,\n <span class=\"hljs-string\">\"twitterName\"</span>: <span class=\"hljs-string\">\"dpup\"</span>,\n <span class=\"hljs-string\">\"role\"</span>: <span class=\"hljs-string\">\"editor\"</span>\n};</code></pre>\n<p>Trong tất cả trường hợp trên, một kí tự kết thúc dòng sẽ gây lỗi phiên mã, và gần như là sẽ làm cho trang web của bạn không hoạt động.</p>\n<h1 id=\"Xu-li-the-nao\"><a class=\"markdownIt-Anchor\" href=\"#Xu-li-the-nao\">#</a> Xử lí thế nào ?</h1>\n<blockquote>\n<p>JSON is done. JSON will not be revised.</p>\n<p><em>Douglas Crockford</em>, <a href=\"https://mail.mozilla.org/pipermail/es-discuss/2009-June/009451.html\">2009</a></p>\n</blockquote>\n<p>Mặc dù trích dẫn ở trên thuộc một cuộc thảo luận khác, tuy nhiên nó vẫn đúng với vấn đề này. Dù tốt hay xấu mình chúng ta buộc phải sử dụng JSON.</p>\n<p>Vì vậy, chúng ta cần một cách để xử lí.</p>\n<p>Một phương án là sẽ esape tất cả kí tự không phải là kí tự ASCII. Ví dụ như với <a href=\"https://github.com/google/closure-library/blob/master/closure/goog/string/string.js#L1003\">hàm escapeString của Closure</a></p>\n<p>Hoặc chúng ta có thể coi 2 kí tự trên là vấn đề, và dùng một hàm tương tự như bạn dưới để xử lí:</p>\n<pre><code class=\"language-js\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">jsStringify</span>(<span class=\"hljs-params\">obj</span>) </span>{\n <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">JSON</span>.stringify(obj)\n .replace(<span class=\"hljs-regexp\">/\\u2028/g</span>, <span class=\"hljs-string\">'\\\\u2028'</span>)\n .replace(<span class=\"hljs-regexp\">/\\u2029/g</span>, <span class=\"hljs-string\">'\\\\u2029'</span>);\n}</code></pre>\n","rawBody":"\nMọi người thường nói rằng JSON là một phần nhỏ (subset) của Javascript.\n\nVấn đề là nó không phải như vậy.\n\nDựa vào [spec](http://www.json.org/) của JSON, một chuỗi có thể chứa bất cứ kí tự unicode nào ngoại trừ `\"` hoặc `/` hoặc kí tự điều khiển.\n\nĐiều là có nghĩa là chuỗi dưới đây hoàn toàn hợp lệ với JSON:\n\n<script src=\"https://gist.github.com/thangngoc89/b136d0aabdbff3d8afa4.js\"></script>\n\nHãy thử copy chuỗi trên và dán vào console, gán cho nó 1 biến bất kì. Thử đi, mình sẽ chờ.\n\nYup. `“SyntaxError: Unexpected token ILLEGAL”.`\n\nVấn đề nằm ở 2 kí tự unicode được được Javascript định nghĩa là kí tự kết thúc dòng: kí tự kết thúc dòng `\\u2028` và kí tự phân cách đoạn văn `u2029`. Chuỗi trên nếu được escape thì sẽ như thế này `own\\u2028ed`.\n\n# Vấn đề nằm ở đâu ?\n\nJSON hiện tại được dùng như là một cách thuận tiện định dạng dữ liệu và hầu hết trường hợp không dùng JSON dựa trên **JSON là một phần nhỏ của JS**. Tuy nhiên, có vài trường hợp nó sẽ gây ra vấn đề.\n\nTrong [JSONP](http://en.wikipedia.org/wiki/JSONP) (JSON with padding), server gửi dữ liệu kèm với một callback sẽ được chạy ở trang yêu cầu dữ liệu:\n\n```js\nhandleResponse({\"status\": \"ok\", \"id\": 123456});\n```\n\nVài thư viện javascript sử dụng một phương thức không an toàn, nhưng nhanh, parse JSON sử dụng `eval` để hỗ trợ các trình duyệt cũ:\n\n```js\nfunction unsafeParse(json) {\n return eval(\"(\" + json + \")\");\n}\n```\n\nVà trường hợp thông dụng nhất là chèn các dữ liệu từ được tạo ra từ server để tránh phải gửi thêm request mới.\n\n```js\nvar GLOBALS = {\n \"userid\": 123456,\n \"twitterName\": \"dpup\",\n \"role\": \"editor\"\n};\n```\n\nTrong tất cả trường hợp trên, một kí tự kết thúc dòng sẽ gây lỗi phiên mã, và gần như là sẽ làm cho trang web của bạn không hoạt động.\n\n# Xử lí thế nào ?\n\n> JSON is done. JSON will not be revised.\n>\n> *Douglas Crockford*, [2009](https://mail.mozilla.org/pipermail/es-discuss/2009-June/009451.html)\n\nMặc dù trích dẫn ở trên thuộc một cuộc thảo luận khác, tuy nhiên nó vẫn đúng với vấn đề này. Dù tốt hay xấu mình chúng ta buộc phải sử dụng JSON.\n\nVì vậy, chúng ta cần một cách để xử lí.\n\nMột phương án là sẽ esape tất cả kí tự không phải là kí tự ASCII. Ví dụ như với [hàm escapeString của Closure](https://github.com/google/closure-library/blob/master/closure/goog/string/string.js#L1003)\n\nHoặc chúng ta có thể coi 2 kí tự trên là vấn đề, và dùng một hàm tương tự như bạn dưới để xử lí:\n\n```js\nfunction jsStringify(obj) {\n return JSON.stringify(obj)\n .replace(/\\u2028/g, '\\\\u2028')\n .replace(/\\u2029/g, '\\\\u2029');\n}\n```\n","raw":"---\nlayout: Post\ntitle: \"json ⊄ js\"\ndate: 2016-02-19 23:22:00\ntags: [js, json]\ntranslate:\n  url: \"https://medium.com/joys-of-javascript/json-js-42a28471221d#.m23ozaapw\"\n  author: \"Dan Pupius\"\n---\n\nMọi người thường nói rằng JSON là một phần nhỏ (subset) của Javascript.\n\nVấn đề là nó không phải như vậy.\n\nDựa vào [spec](http://www.json.org/) của JSON, một chuỗi có thể chứa bất cứ kí tự unicode nào ngoại trừ `\"` hoặc `/` hoặc kí tự điều khiển.\n\nĐiều là có nghĩa là chuỗi dưới đây hoàn toàn hợp lệ với JSON:\n\n<script src=\"https://gist.github.com/thangngoc89/b136d0aabdbff3d8afa4.js\"></script>\n\nHãy thử copy chuỗi trên và dán vào console, gán cho nó 1 biến bất kì. Thử đi, mình sẽ chờ.\n\nYup. `“SyntaxError: Unexpected token ILLEGAL”.`\n\nVấn đề nằm ở 2 kí tự unicode được được Javascript định nghĩa là kí tự kết thúc dòng: kí tự kết thúc dòng `\\u2028` và kí tự phân cách đoạn văn `u2029`. Chuỗi trên nếu được escape thì sẽ như thế này `own\\u2028ed`.\n\n# Vấn đề nằm ở đâu ?\n\nJSON hiện tại được dùng như là một cách thuận tiện định dạng dữ liệu và hầu hết trường hợp không dùng JSON dựa trên **JSON là một phần nhỏ của JS**. Tuy nhiên, có vài trường hợp nó sẽ gây ra vấn đề.\n\nTrong [JSONP](http://en.wikipedia.org/wiki/JSONP) (JSON with padding), server gửi dữ liệu kèm với một callback sẽ được chạy ở trang yêu cầu dữ liệu:\n\n```js\nhandleResponse({\"status\": \"ok\", \"id\": 123456});\n```\n\nVài thư viện javascript sử dụng một phương thức không an toàn, nhưng nhanh, parse JSON sử dụng `eval` để hỗ trợ các trình duyệt cũ:\n\n```js\nfunction unsafeParse(json) {\n return eval(\"(\" + json + \")\");\n}\n```\n\nVà trường hợp thông dụng nhất là chèn các dữ liệu từ được tạo ra từ server để tránh phải gửi thêm request mới.\n\n```js\nvar GLOBALS = {\n \"userid\": 123456,\n \"twitterName\": \"dpup\",\n \"role\": \"editor\"\n};\n```\n\nTrong tất cả trường hợp trên, một kí tự kết thúc dòng sẽ gây lỗi phiên mã, và gần như là sẽ làm cho trang web của bạn không hoạt động.\n\n# Xử lí thế nào ?\n\n> JSON is done. JSON will not be revised.\n>\n> *Douglas Crockford*, [2009](https://mail.mozilla.org/pipermail/es-discuss/2009-June/009451.html)\n\nMặc dù trích dẫn ở trên thuộc một cuộc thảo luận khác, tuy nhiên nó vẫn đúng với vấn đề này. Dù tốt hay xấu mình chúng ta buộc phải sử dụng JSON.\n\nVì vậy, chúng ta cần một cách để xử lí.\n\nMột phương án là sẽ esape tất cả kí tự không phải là kí tự ASCII. Ví dụ như với [hàm escapeString của Closure](https://github.com/google/closure-library/blob/master/closure/goog/string/string.js#L1003)\n\nHoặc chúng ta có thể coi 2 kí tự trên là vấn đề, và dùng một hàm tương tự như bạn dưới để xử lí:\n\n```js\nfunction jsStringify(obj) {\n return JSON.stringify(obj)\n .replace(/\\u2028/g, '\\\\u2028')\n .replace(/\\u2029/g, '\\\\u2029');\n}\n```\n","__filename":"json-js.md","__url":"/json-js/","__resourceUrl":"/json-js/index.html","__dataUrl":"/json-js/index.html.f31a458895df66d2dbc2a8574fde3a6c.json"}